name: "02_distributed_runtime_filter"
description: "Test for distributed runtime filter"

sql: |
  SELECT t1.a0f, t3.a1d, t1.a0g, floor(t1.a0p / 500)::Int32 AS grjcjs, floor(t1.a0x / 300)::Int32 AS gryjce, floor(t1.a0y / 300)::Int32 AS dwyjce, t2.cjny, t1.a0o, t2.ljjccs, DATE_DIFF(MONTH, to_date(t2.cjny::STRING || '01'), to_date(CASE WHEN t1.a0o IS NULL OR t1.a0o = '' THEN CASE WHEN t1.a0t IS NULL OR t1.a0t = '' THEN t1.a0u END ELSE t1.a0o || '01' END)) + 1 - t2.ljjccs AS ljzdcs, CASE WHEN t3.a3f = '机关单位' THEN '1' WHEN t3.a3f = '事业单位' THEN '2' WHEN t3.a2d = '金融业' THEN '5' WHEN t4.a1d IS NOT NULL THEN '3' WHEN t3.a1y IN('1210', '1211', '1212', '1213', '1219', '5220', '5240', '5260', '6220', '6240', '6260', '6280') THEN '4' ELSE '6' END AS xzdm, t3.a1q, CASE WHEN t1.a0z = '正常' THEN '1' WHEN t1.a0z = '封存' THEN '2' WHEN t1.a0z = '销户' THEN '3' WHEN t1.a0z = '缓缴' THEN '4' END AS dwzhzt, t1.a0e, a1a, dyjczt, dygrjcbl, dydwjcbl, dyjce, t5.jesgygryjcjl FROM (SELECT a0d, a0f, a0g, CASE WHEN a0h IN('0', '统一社会信用代码') AND length(a0i) = 18 THEN SUBSTRING(a0i FROM 9 FOR 9) ELSE a0i END AS zzjgdm, a0p, a0x, a0y, a0o, a0z, CASE WHEN a0e IS NULL OR a0e = '' THEN '0' WHEN a0e IN('二代身份证', '01') THEN '1' WHEN a0e = '港澳通行证（或居住证）' THEN '2' WHEN a0e = '台胞证（或居住证）' THEN '3' WHEN a0e = '军官证' THEN '4' WHEN a0e = '护照' THEN '5' WHEN a0e = '外国人永久居住证' THEN '6' ELSE '7' END AS zjlx, CASE WHEN a1a = '省直公积金中心' THEN '0' WHEN a1a = '福州公积金中心' THEN '1' WHEN a1a = '莆田公积金中心' THEN '2' WHEN a1a = '泉州公积金中心' THEN '3' WHEN a1a = '厦门公积金中心' THEN '4' WHEN a1a = '漳州公积金中心' THEN '5' WHEN a1a = '龙岩公积金中心' THEN '6' WHEN a1a = '三明公积金中心' THEN '7' WHEN a1a = '南平公积金中心' THEN '8' WHEN a1a = '宁德公积金中心' THEN '9' WHEN a1a = '平潭公积金中心' THEN '10' WHEN a1a = '福州公积金中心能源职工' THEN '11' WHEN a1a = '福州公积金中心铁路职工' THEN '12' END AS khzxbh, CASE WHEN a0w = '汇缴' THEN '01' WHEN a0w = '补缴' THEN '02' END AS dyjczt, CASE WHEN a0k >= 0 AND a0k <= 5 THEN '0' WHEN a0k > 5 AND a0k <= 8 THEN '1' WHEN a0k > 8 AND a0k <= 10 THEN '2' WHEN a0k > 10 AND a0k <= 12 THEN '3' WHEN a0k > 12 THEN '4' END AS dygrjcbl, CASE WHEN a0l >= 0 AND a0l <= 5 THEN '0' WHEN a0l > 5 AND a0l <= 8 THEN '1' WHEN a0l > 8 AND a0l <= 10 THEN '2' WHEN a0l > 10 AND a0l <= 12 THEN '3' WHEN a0l > 12 THEN '4' END AS dydwjcbl, floor(a0v / 300)::Int32 AS dyjce, a0t, a0u FROM a0c QUALIFY row_number() OVER (PARTITION BY a0f ORDER BY a0t DESC NULLS LAST) = 1) AS t1 LEFT OUTER JOIN (SELECT a0f, min(to_yyyymm(a0t)) AS cjny, count(DISTINCT to_yyyymm(a0t)) AS ljjccs FROM a0c WHERE a0w = '汇缴' GROUP BY a0f) AS t2 ON t1.a0f = t2.a0f LEFT OUTER JOIN (SELECT a1d, a2d, a1y, a3f, a1q, SUBSTRING(a1d FROM 9 FOR 9) AS zzjgdm FROM a1b WHERE a3f IN('企业', '机关单位', '事业单位')) AS t3 ON t1.a0i = t3.a0i LEFT OUTER JOIN a3r AS t4 ON t3.a1d = t4.a1d LEFT OUTER JOIN (SELECT a0f, '[' || string_agg(json_object('grjcbl', CASE WHEN a0k::Int32 = 0 THEN '0' WHEN a0k::Int32 = 5 THEN '1' WHEN a0k::Int32 = 8 THEN '2' WHEN a0k::Int32 = 10 THEN '3' WHEN a0k::Int32 = 12 THEN '4' END, 'dwjcbl', CASE WHEN a0l::Int32 = 0 THEN '0' WHEN a0l::Int32 = 5 THEN '1' WHEN a0l::Int32 = 8 THEN '2' WHEN a0l::Int32 = 10 THEN '3' WHEN a0l::Int32 = 12 THEN '4' END, 'dyjczt', CASE WHEN a0w = '汇缴' THEN '01' WHEN a0w = '补缴' THEN '02' END, 'myjce', floor(a0v / 300)::Int32, 'hbjny', to_yyyymm(a0t))::STRING, ',') || ']' AS jesgygryjcjl FROM (SELECT * FROM a0c WHERE a0t <> '' QUALIFY row_number() OVER (PARTITION BY a0f ORDER BY a0t DESC NULLS LAST) BETWEEN 2 AND 25) AS m5 GROUP BY a0f) AS t5 ON t1.a0f = t5.a0f;

# Reference to external statistics file
statistics_file: obfuscated/02_distributed_runtime_filter_stats.yaml 