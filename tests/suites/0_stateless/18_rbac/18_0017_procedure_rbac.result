=== Setting up user connection strings ===
=== Creating roles ===
=== Creating users ===
=== Granting roles to users ===
=== Testing global CREATE PROCEDURE permission ===
=== admin_user: Creating procedures ===
1. Creating add_numbers procedure...
2. Creating get_current_time procedure...
=== Testing dev_user and test_user cannot create procedures ===
3. dev_user tries to create test_proc (should fail)...
Error: APIError: QueryFailed: [1063]Permission denied: privilege [CreateProcedure] is required on *.* for user 'dev_user'@'%' with roles [dev_role]. Note: Please ensure that your current role have the appropriate permissions to create a new Object
4. test_user tries to create test_proc (should fail)...
Error: APIError: QueryFailed: [1063]Permission denied: privilege [CreateProcedure] is required on *.* for user 'test_user'@'%' with roles [test_role]. Note: Please ensure that your current role have the appropriate permissions to create a new Object
=== Testing ACCESS PROCEDURE permission ===
5. Granting dev_role access to add_numbers...
6. dev_user calls add_numbers (should succeed)...
7
7. test_user calls add_numbers (should fail)...
Error: APIError: QueryFailed: [1063]Permission denied: privilege [AccessProcedure] is required on PROCEDURE for user 'test_user'@'%' with roles [public,test_role]. Note: Please ensure that your current role have the appropriate permissions to create a new Object
8. Granting test_role access to get_current_time...
9. test_user calls get_current_time (should succeed)...
0
=== Testing ownership transfer ===
10. admin_user creates multiply_numbers...
11. Transferring ownership of multiply_numbers to dev_role...
12. dev_user describes multiply_numbers (should succeed)...
signature	(a,b)
returns	(Int32)
language	SQL
body	"BEGIN
    RETURN a * b;
END;"
13. test_user describes multiply_numbers (should fail)...
Error: APIError: QueryFailed: [1063]Permission denied: privilege [AccessProcedure] is required on PROCEDURE for user 'test_user'@'%' with roles [public,test_role]. Note: Please ensure that your current role have the appropriate permissions to create a new Object
=== Testing ownership chaining ===
14. Transferring ownership of multiply_numbers to test_role...
15. dev_user describes multiply_numbers (should fail)...
Error: APIError: QueryFailed: [1063]Permission denied: privilege [AccessProcedure] is required on PROCEDURE for user 'dev_user'@'%' with roles [dev_role,public]. Note: Please ensure that your current role have the appropriate permissions to create a new Object
16. dev_user calls multiply_numbers (should fail)...
Error: APIError: QueryFailed: [1063]Permission denied: privilege [AccessProcedure] is required on PROCEDURE for user 'dev_user'@'%' with roles [dev_role,public]. Note: Please ensure that your current role have the appropriate permissions to create a new Object
17. test_user describes multiply_numbers (should succeed)...
signature	(a,b)
returns	(Int32)
language	SQL
body	"BEGIN
    RETURN a * b;
END;"
18. test_user calls multiply_numbers (should succeed)...
2
=== Testing permission inheritance ===
19. Creating test_with_access role...
20. Granting test_with_access access to add_numbers...
21. test_user calls add_numbers (should fail, not yet granted role)...
Error: APIError: QueryFailed: [1063]Permission denied: privilege [AccessProcedure] is required on PROCEDURE for user 'test_user'@'%' with roles [public,test_role]. Note: Please ensure that your current role have the appropriate permissions to create a new Object
22. Granting test_with_access to test_user...
23. test_user calls add_numbers (should succeed)...
11
=== Testing permission revocation ===
24. Revoking test_with_access's access to add_numbers...
25. test_user calls add_numbers (should fail)...
Error: APIError: QueryFailed: [1063]Permission denied: privilege [AccessProcedure] is required on PROCEDURE for user 'test_user'@'%' with roles [public,test_role,test_with_access]. Note: Please ensure that your current role have the appropriate permissions to create a new Object
26. test_user describes add_numbers (should fail)...
Error: APIError: QueryFailed: [1063]Permission denied: privilege [AccessProcedure] is required on PROCEDURE for user 'test_user'@'%' with roles [public,test_role,test_with_access]. Note: Please ensure that your current role have the appropriate permissions to create a new Object
=== Testing procedure without parameters ===
27. Creating greet procedure...
28. Granting dev_role access to greet...
29. dev_user calls greet (should succeed)...
Hello, Databend!
30. test_user calls greet (should fail)...
Error: APIError: QueryFailed: [1063]Permission denied: privilege [AccessProcedure] is required on PROCEDURE for user 'test_user'@'%' with roles [public,test_role,test_with_access]. Note: Please ensure that your current role have the appropriate permissions to create a new Object
=== Testing system.procedures visibility ===
31. admin_user queries system.procedures (should see add_numbers, get_current_time via ownership)...
add_numbers
get_current_time
add_numbers
get_current_time
greet
multiply_numbers
32. dev_user queries system.procedures (should see add_numbers and greet via grant)...
add_numbers
greet
33. test_user queries system.procedures (should see get_current_time via grant, multiply_numbers via ownership)...
get_current_time
multiply_numbers
=== Cleaning up test environment ===
34. Dropping users...
35. Dropping roles...
36. Dropping procedures...
=== Test script completed ===
