control sortmode rowsort

statement ok
create or replace database db;

statement ok
use db;

# simple recursive CTE
query I
with recursive t as (select 1 as x union all select x+1 from t where x < 3) select * from t
----
1
2
3

# simple recursive CTE with an alias
query I
with recursive t as (select 1 as x union all select x+1 from t as m where m.x < 3) select * from t
----
1
2
3

# recursive CTE with multiple references and aliases
onlyif todo
query I
with recursive t as (select 1 as x union all select m.x+f.x from t as m, t as f where m.x < 3) select * from t
----
1
2
4

# strings and multiple columns
query IT
with recursive t as (select 1 as x, 'hello' as y union all select x+1, y || '-' || 'hello' from t where x < 3) select * from t;
----
1	hello
2	hello-hello
3	hello-hello-hello

onlyif todo
# referencing same CTE multiple times
query I
with recursive t as (select 1 as x union all select x+1 from t where x < 3) select min(a1.x) from t a1, t a2;
----
1

# nested uncorrelated subquery
query I
with recursive t as (select 1 as x union all select x+(SELECT 1) from t where x < 3) select * from t;
----
1
2
3


# recursive CTE with table-producing function
query I
WITH RECURSIVE t AS (
	SELECT 1 AS i
	UNION ALL
	SELECT j
	FROM t, generate_series(0, 10, 1) series(j)
	WHERE j=i+1
)
SELECT * FROM t;
----
1
10
2
3
4
5
6
7
8
9

# bug: https://github.com/databendlabs/databend/issues/17027
statement ok
CREATE or replace TABLE parent_child
(
  parent VARCHAR(30),
  child VARCHAR(30)
);

statement ok
INSERT INTO parent_child
VALUES ('Org','Org'),('Org','Global'),('Global','North'),
('Global','South'),('Global','East'),('Global','West'),
('Global','Org detail'),('North','North East'),('North','North West');

query TT
WITH RECURSIVE tree_values
    (parent, child)
AS (
    SELECT parent, child
    FROM parent_child
    WHERE parent = child
    UNION ALL
    SELECT c.parent, c.child
    FROM parent_child c
    INNER JOIN tree_values p
    ON p.child = c.parent
    WHERE c.parent != c.child
)
select parent, child from tree_values
where parent = 'Global';
----
Global East
Global North
Global Org detail
Global South
Global West

statement ok
drop table parent_child;

query II
WITH RECURSIVE aoc10_input(i) AS (SELECT '\n89010123\n78121874\n87430965\n96549874\n45678903\n32019012\n01329801\n10456732\n'), lines(y, line, rest) AS (SELECT 0::UInt64, substr(i, 1, position('\n' IN i) - 1), substr(i, position('\n' IN i) + 1) FROM aoc10_input UNION ALL SELECT y + 1::UInt64, substr(rest, 1, position('\n' IN rest) - 1), substr(rest, position('\n' IN rest) + 1) FROM lines WHERE position('\n' IN rest) > 0), field(x, y, v) AS (SELECT x::UInt64 AS x, y, (ascii(substr(line, x::Int64, 1)) - 48)::UInt64 AS v FROM (SELECT * FROM lines l WHERE line <> '') s, LATERAL generate_series(1, length(line)) g(x)), paths(x, y, v, sx, sy) AS (SELECT x, y, 9::UInt64, x, y FROM field WHERE v = 9 UNION ALL SELECT f.x, f.y, f.v, p.sx, p.sy FROM field f JOIN paths p ON f.v = p.v - 1 AND p.v > 0 AND ((f.x = p.x AND abs(f.y - p.y) = 1) OR (f.y = p.y AND abs(f.x - p.x) = 1))), results AS (SELECT * FROM paths WHERE v = 0), part1 AS (SELECT DISTINCT * FROM results) SELECT (SELECT count(*) FROM part1) AS part1, (SELECT count(*) FROM results) AS part2;
----
36 81
