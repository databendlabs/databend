# Q31
query I
WITH ss AS
  (SELECT ca_county,
          d_qoy,
          d_year,
          sum(ss_ext_sales_price) AS store_sales
   FROM store_sales,
        date_dim,
        customer_address
   WHERE ss_sold_date_sk = d_date_sk
     AND ss_addr_sk=ca_address_sk
   GROUP BY ca_county,
            d_qoy,
            d_year),
     ws AS
  (SELECT ca_county,
          d_qoy,
          d_year,
          sum(ws_ext_sales_price) AS web_sales
   FROM web_sales,
        date_dim,
        customer_address
   WHERE ws_sold_date_sk = d_date_sk
     AND ws_bill_addr_sk=ca_address_sk
   GROUP BY ca_county,
            d_qoy,
            d_year)
SELECT ss1.ca_county ,
       ss1.d_year ,
       (ws2.web_sales*1.0000)/ws1.web_sales web_q1_q2_increase ,
       (ss2.store_sales*1.0000)/ss1.store_sales store_q1_q2_increase ,
       (ws3.web_sales*1.0000)/ws2.web_sales web_q2_q3_increase ,
       (ss3.store_sales*1.0000)/ss2.store_sales store_q2_q3_increase
FROM ss ss1 ,
     ss ss2 ,
     ss ss3 ,
     ws ws1 ,
     ws ws2 ,
     ws ws3
WHERE ss1.d_qoy = 1
  AND ss1.d_year = 2000
  AND ss1.ca_county = ss2.ca_county
  AND ss2.d_qoy = 2
  AND ss2.d_year = 2000
  AND ss2.ca_county = ss3.ca_county
  AND ss3.d_qoy = 3
  AND ss3.d_year = 2000
  AND ss1.ca_county = ws1.ca_county
  AND ws1.d_qoy = 1
  AND ws1.d_year = 2000
  AND ws1.ca_county = ws2.ca_county
  AND ws2.d_qoy = 2
  AND ws2.d_year = 2000
  AND ws1.ca_county = ws3.ca_county
  AND ws3.d_qoy = 3
  AND ws3.d_year = 2000
  AND CASE
          WHEN ws1.web_sales > 0 THEN (ws2.web_sales*1.0000)/ws1.web_sales
          ELSE NULL
      END > CASE
                WHEN ss1.store_sales > 0 THEN (ss2.store_sales*1.0000)/ss1.store_sales
                ELSE NULL
            END
  AND CASE
          WHEN ws2.web_sales > 0 THEN (ws3.web_sales*1.0000)/ws2.web_sales
          ELSE NULL
      END > CASE
                WHEN ss2.store_sales > 0 THEN (ss3.store_sales*1.0000)/ss2.store_sales
                ELSE NULL
            END
ORDER BY ss1.ca_county;
----
Atchison County 2000 0.979594880351 0.338811193071 7.440304982579 1.788463248444
Bacon County 2000 1.090672331028 0.153186918701 1.196619858502 0.834086089760
Berkshire County 2000 1.841093693587 1.222157174514 1.564153607521 1.246635189748
Blue Earth County 2000 8.913248334932 0.541756488843 0.391444310731 0.385909018261
Bourbon County 2000 1.940226154546 0.778069477528 1.560924894583 1.227445311282
Boyd County 2000 1.219972731193 1.084267413667 1.270903743659 1.204192439711
Bradley County 2000 2.713177401713 0.961175914393 1.376919502997 0.694176616318
Buchanan County 2000 0.828926823470 0.710318098807 6.950155195705 2.054632092711
Cass County 2000 1.694130226833 1.147234898729 2.702644199811 1.265409237688
Cook County 2000 1.787724675662 0.847709176070 2.200098777775 1.574454650424
Corson County 2000 1.709337823637 0.247126981907 1.693672700477 1.580396851037
Edmonson County 2000 0.671752166907 0.493260341425 2.575951260814 0.982562582027
Ferry County 2000 1.824821667754 0.323131839418 1.924438339394 1.210086119077
Fillmore County 2000 0.789730605754 0.258588958470 1.665477086145 1.149218460791
Fremont County 2000 3.219034577385 0.494786007104 1.853122998879 1.549095175905
Gaston County 2000 1.194604428230 0.336071059515 4.564338454766 1.559277145455
Gates County 2000 0.912221036004 0.261797664417 2.889296085365 2.255780293607
Green County 2000 0.774878284028 0.330823316063 5.185149904347 3.912295355900
Greene County 2000 0.888125202118 0.830953728665 2.049974934640 1.987579693671
Harris County 2000 0.897005949747 0.239650470708 3.739830432076 1.628898369869
Heard County 2000 3.370087800534 1.862446189197 1.637083197814 0.586831233057
Houston County 2000 1.390104528446 1.106577817403 1.990538572629 1.530412891569
Lake County 2000 1.283037854153 0.882009087231 1.365982160091 1.223152169403
Lamar County 2000 0.848381448771 0.775988920090 4.520095150484 2.186866923631
Marion County 2000 1.069030045535 0.826253722136 2.758457444613 1.879714855949
Mitchell County 2000 3.530864575166 1.090343469887 2.042721502394 1.437166731240
Mora County 2000 2.108264798031 0.429651371315 1.442197048856 0.891789716702
Nicholas County 2000 2.321985048861 2.051937769296 3.805137425709 1.203177531936
Oceana County 2000 1.082441246459 0.845879168827 1.166759514534 0.935630052988
Pocahontas County 2000 0.924835518394 0.705667721300 1.897392930177 1.062891013305
Pottawatomie County 2000 0.436886904612 0.364719811780 3.291989743486 2.778401665813
Refugio County 2000 0.724023551322 0.544866710222 2.715205714413 1.385720862614
Santa Cruz County 2000 1.152417063660 1.117822727552 2.831705135708 1.989474306680
Smith County 2000 1.049390133084 0.496404899762 3.900881322641 3.711118404247
Stanton County 2000 2.394973571214 0.954097193445 0.979666945205 0.894249837843
Stark County 2000 2.801957795293 1.340377271083 2.303575028474 0.777974888804
Stone County 2000 0.947343662414 0.840278095845 5.935235220706 1.237367223906
Tooele County 2000 2.026778819822 0.541613493347 1.174794759837 0.695829575297
Vernon County 2000 2.262711522239 1.626728336689 1.770786780730 1.237619558339
Wabash County 2000 1.111361457159 0.686835526896 2.180161169759 1.612175695100
Wayne County 2000 2.638013723962 0.675140898418 2.941538537266 2.414871392819
Webster County 2000 0.604005183435 0.588561538633 3.008916135411 1.730187577260
Wheeler County 2000 1.610547603234 0.605963509542 0.817801307950 0.788889792566
Williamson County 2000 1.614744536845 0.443873134688 4.080301148443 3.342687494478


