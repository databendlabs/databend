# Q53
query IRR
SELECT *
FROM
  (SELECT i_manufact_id,
          sum(ss_sales_price) sum_sales,
          avg(sum(ss_sales_price)) OVER (PARTITION BY i_manufact_id) avg_quarterly_sales
   FROM item,
        store_sales,
        date_dim,
        store
   WHERE ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND ss_store_sk = s_store_sk
     AND d_month_seq IN (1200,
                         1200+1,
                         1200+2,
                         1200+3,
                         1200+4,
                         1200+5,
                         1200+6,
                         1200+7,
                         1200+8,
                         1200+9,
                         1200+10,
                         1200+11)
     AND ((i_category IN ('Books',
                          'Children',
                          'Electronics')
           AND i_class IN ('personal',
                           'portable',
                           'reference',
                           'self-help')
           AND i_brand IN ('scholaramalgamalg #14',
                           'scholaramalgamalg #7',
                           'exportiunivamalg #9',
                           'scholaramalgamalg #9')) or(i_category IN ('Women','Music','Men')
                                                       AND i_class IN ('accessories','classical','fragrances','pants')
                                                       AND i_brand IN ('amalgimporto #1','edu packscholar #1','exportiimporto #1', 'importoamalg #1')))
   GROUP BY i_manufact_id,
            d_qoy) tmp1
WHERE CASE
          WHEN avg_quarterly_sales > 0 THEN ABS (sum_sales - avg_quarterly_sales)/ avg_quarterly_sales
          ELSE NULL
      END > 0.1
ORDER BY avg_quarterly_sales,
         sum_sales,
         i_manufact_id
LIMIT 100;
----
827 86.44 284.6175
827 349.77 284.6175
827 417.55 284.6175
360 131.29 370.0250
360 198.02 370.0250
360 266.37 370.0250
360 884.42 370.0250
812 257.48 378.6275
812 300.17 378.6275
812 310.62 378.6275
812 646.24 378.6275
247 197.83 381.1150
247 289.54 381.1150
247 478.79 381.1150
247 558.30 381.1150
134 225.26 391.3175
134 240.65 391.3175
134 449.77 391.3175
134 649.59 391.3175
554 79.27 402.7125
554 213.69 402.7125
554 293.41 402.7125
554 1024.48 402.7125
411 161.47 403.7325
411 254.01 403.7325
411 781.15 403.7325
147 181.75 407.7025
147 195.77 407.7025
147 514.21 407.7025
147 739.08 407.7025
384 243.55 418.4125
384 335.90 418.4125
384 539.46 418.4125
384 554.74 418.4125
272 198.52 422.9925
272 251.97 422.9925
272 533.33 422.9925
272 708.15 422.9925
621 274.67 424.1250
621 290.96 424.1250
621 326.67 424.1250
621 804.20 424.1250
619 193.92 428.6825
619 359.91 428.6825
619 689.55 428.6825
141 197.58 428.9925
141 321.08 428.9925
141 794.81 428.9925
440 83.69 431.7800
440 246.92 431.7800
440 632.40 431.7800
440 764.11 431.7800
70 145.64 432.4275
70 359.22 432.4275
70 529.47 432.4275
70 695.38 432.4275
159 120.70 432.8925
159 353.38 432.8925
159 511.45 432.8925
159 746.04 432.8925
507 230.77 433.1225
507 363.83 433.1225
507 698.57 433.1225
860 164.90 434.2675
860 380.73 434.2675
860 524.21 434.2675
860 667.23 434.2675
39 94.42 435.0150
39 479.18 435.0150
39 534.58 435.0150
39 631.88 435.0150
362 245.25 441.2500
362 327.74 441.2500
362 567.34 441.2500
362 624.67 441.2500
278 186.10 441.5425
278 274.39 441.5425
278 595.33 441.5425
278 710.35 441.5425
636 136.44 444.3350
636 284.75 444.3350
636 877.04 444.3350
251 114.98 444.4250
251 266.16 444.4250
251 619.22 444.4250
251 777.34 444.4250
648 110.80 446.3900
648 208.38 446.3900
648 698.37 446.3900
648 768.01 446.3900
242 206.99 447.0750
242 237.00 447.0750
242 346.94 447.0750
242 997.37 447.0750
332 228.43 451.6175
332 373.65 451.6175
332 560.44 451.6175
332 643.95 451.6175
441 66.59 452.8125
441 281.62 452.8125
