# Q63
query IRR

SELECT *
FROM
  (SELECT i_manager_id,
          sum(ss_sales_price) sum_sales,
          avg(sum(ss_sales_price)) OVER (PARTITION BY i_manager_id) avg_monthly_sales
   FROM item,
        store_sales,
        date_dim,
        store
   WHERE ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND ss_store_sk = s_store_sk
     AND d_month_seq IN (1200,
                         1200+1,
                         1200+2,
                         1200+3,
                         1200+4,
                         1200+5,
                         1200+6,
                         1200+7,
                         1200+8,
                         1200+9,
                         1200+10,
                         1200+11)
     AND ((i_category IN ('Books',
                          'Children',
                          'Electronics')
           AND i_class IN ('personal',
                           'portable',
                           'reference',
                           'self-help')
           AND i_brand IN ('scholaramalgamalg #14',
                           'scholaramalgamalg #7',
                           'exportiunivamalg #9',
                           'scholaramalgamalg #9')) or(i_category IN ('Women','Music','Men')
                                                       AND i_class IN ('accessories','classical','fragrances','pants')
                                                       AND i_brand IN ('amalgimporto #1','edu packscholar #1','exportiimporto #1', 'importoamalg #1')))
   GROUP BY i_manager_id,
            d_moy) tmp1
WHERE CASE
          WHEN avg_monthly_sales > 0 THEN ABS (sum_sales - avg_monthly_sales) / avg_monthly_sales
          ELSE NULL
      END > 0.1
ORDER BY i_manager_id,
         avg_monthly_sales,
         sum_sales
LIMIT 100;
----
1 122.92 612.8008
1 271.20 612.8008
1 324.29 612.8008
1 391.74 612.8008
1 504.62 612.8008
1 542.37 612.8008
1 679.25 612.8008
1 873.89 612.8008
1 892.28 612.8008
1 920.79 612.8008
1 1215.74 612.8008
2 150.13 529.7425
2 264.16 529.7425
2 283.39 529.7425
2 318.31 529.7425
2 368.51 529.7425
2 372.82 529.7425
2 620.55 529.7425
2 655.70 529.7425
2 917.50 529.7425
2 946.91 529.7425
2 958.37 529.7425
3 308.88 1005.7441
3 459.90 1005.7441
3 472.12 1005.7441
3 524.55 1005.7441
3 679.56 1005.7441
3 1177.72 1005.7441
3 1531.50 1005.7441
3 1735.53 1005.7441
3 2152.01 1005.7441
5 549.48 1118.3650
5 579.30 1118.3650
5 660.99 1118.3650
5 663.38 1118.3650
5 800.39 1118.3650
5 905.38 1118.3650
5 950.61 1118.3650
5 1503.56 1118.3650
5 1627.04 1118.3650
5 1883.02 1118.3650
5 2169.53 1118.3650
6 616.31 1883.9600
6 842.33 1883.9600
6 928.93 1883.9600
6 1034.24 1883.9600
6 1120.96 1883.9600
6 1241.23 1883.9600
6 1528.10 1883.9600
6 2242.79 1883.9600
6 2553.84 1883.9600
6 2614.18 1883.9600
6 3566.95 1883.9600
6 4317.66 1883.9600
7 803.93 1564.6175
7 821.79 1564.6175
7 842.89 1564.6175
7 914.62 1564.6175
7 982.68 1564.6175
7 1190.12 1564.6175
7 1372.28 1564.6175
7 1756.83 1564.6175
7 1968.10 1564.6175
7 2022.35 1564.6175
7 2788.38 1564.6175
7 3311.44 1564.6175
8 707.60 1568.4850
8 764.98 1568.4850
8 802.16 1568.4850
8 903.04 1568.4850
8 940.24 1568.4850
8 1365.01 1568.4850
8 1371.52 1568.4850
8 1744.71 1568.4850
8 1840.43 1568.4850
8 2360.83 1568.4850
8 2904.40 1568.4850
8 3116.90 1568.4850
9 574.79 1592.7108
9 634.60 1592.7108
9 652.64 1592.7108
9 725.48 1592.7108
9 766.49 1592.7108
9 946.68 1592.7108
9 1016.80 1592.7108
9 1885.91 1592.7108
9 2291.90 1592.7108
9 2524.35 1592.7108
9 3469.69 1592.7108
9 3623.20 1592.7108
10 458.18 1152.1908
10 495.48 1152.1908
10 697.28 1152.1908
10 763.47 1152.1908
10 842.90 1152.1908
10 850.00 1152.1908
10 1269.99 1152.1908
10 1404.21 1152.1908
10 2057.38 1152.1908
10 2721.23 1152.1908


