# Q75
query I
WITH all_sales AS
  ( SELECT d_year ,
           i_brand_id ,
           i_class_id ,
           i_category_id ,
           i_manufact_id ,
           SUM(sales_cnt) AS sales_cnt ,
           SUM(sales_amt) AS sales_amt
   FROM
     (SELECT d_year ,
             i_brand_id ,
             i_class_id ,
             i_category_id ,
             i_manufact_id ,
             cs_quantity - COALESCE(cr_return_quantity,0) AS sales_cnt ,
             cs_ext_sales_price - COALESCE(cr_return_amount,0.0) AS sales_amt
      FROM catalog_sales
      JOIN item ON i_item_sk=cs_item_sk
      JOIN date_dim ON d_date_sk=cs_sold_date_sk
      LEFT JOIN catalog_returns ON (cs_order_number=cr_order_number
                                    AND cs_item_sk=cr_item_sk)
      WHERE i_category='Books'
      UNION SELECT d_year ,
                   i_brand_id ,
                   i_class_id ,
                   i_category_id ,
                   i_manufact_id ,
                   ss_quantity - COALESCE(sr_return_quantity,0) AS sales_cnt ,
                   ss_ext_sales_price - COALESCE(sr_return_amt,0.0) AS sales_amt
      FROM store_sales
      JOIN item ON i_item_sk=ss_item_sk
      JOIN date_dim ON d_date_sk=ss_sold_date_sk
      LEFT JOIN store_returns ON (ss_ticket_number=sr_ticket_number
                                  AND ss_item_sk=sr_item_sk)
      WHERE i_category='Books'
      UNION SELECT d_year ,
                   i_brand_id ,
                   i_class_id ,
                   i_category_id ,
                   i_manufact_id ,
                   ws_quantity - COALESCE(wr_return_quantity,0) AS sales_cnt ,
                   ws_ext_sales_price - COALESCE(wr_return_amt,0.0) AS sales_amt
      FROM web_sales
      JOIN item ON i_item_sk=ws_item_sk
      JOIN date_dim ON d_date_sk=ws_sold_date_sk
      LEFT JOIN web_returns ON (ws_order_number=wr_order_number
                                AND ws_item_sk=wr_item_sk)
      WHERE i_category='Books') sales_detail
   GROUP BY d_year,
            i_brand_id,
            i_class_id,
            i_category_id,
            i_manufact_id)
SELECT prev_yr.d_year AS prev_year ,
       curr_yr.d_year AS year_ ,
       curr_yr.i_brand_id ,
       curr_yr.i_class_id ,
       curr_yr.i_category_id ,
       curr_yr.i_manufact_id ,
       prev_yr.sales_cnt AS prev_yr_cnt ,
       curr_yr.sales_cnt AS curr_yr_cnt ,
       curr_yr.sales_cnt-prev_yr.sales_cnt AS sales_cnt_diff ,
       curr_yr.sales_amt-prev_yr.sales_amt AS sales_amt_diff
FROM all_sales curr_yr,
     all_sales prev_yr
WHERE curr_yr.i_brand_id=prev_yr.i_brand_id
  AND curr_yr.i_class_id=prev_yr.i_class_id
  AND curr_yr.i_category_id=prev_yr.i_category_id
  AND curr_yr.i_manufact_id=prev_yr.i_manufact_id
  AND curr_yr.d_year=2002
  AND prev_yr.d_year=2002-1
  AND CAST(curr_yr.sales_cnt AS DECIMAL(17,2))/CAST(prev_yr.sales_cnt AS DECIMAL(17,2))<0.9
ORDER BY sales_cnt_diff,
         sales_amt_diff
LIMIT 100;
----
2001 2002 9011010 11 9 254 7800 5501 -2299 -108339.67
2001 2002 9016002 16 9 761 6355 4107 -2248 -87034.02
2001 2002 2001001 7 9 85 5804 3901 -1903 -113006.60
2001 2002 9013010 12 9 28 6147 4252 -1895 -79962.28
2001 2002 9009010 1 9 311 7151 5271 -1880 -108594.45
2001 2002 9006010 6 9 373 6166 4361 -1805 -49562.85
2001 2002 6013005 12 9 513 5396 3724 -1672 -111944.58
2001 2002 9004002 4 9 55 5893 4222 -1671 -105000.27
2001 2002 9006006 6 9 36 6197 4589 -1608 -41703.81
2001 2002 9006010 3 9 99 5845 4248 -1597 -75341.47
2001 2002 1003001 3 9 242 6116 4527 -1589 -26092.37
2001 2002 9006002 6 9 903 5448 3869 -1579 -49244.90
2001 2002 9010008 10 9 621 5809 4244 -1565 -65205.88
2001 2002 9002002 2 9 556 6049 4528 -1521 -75082.11
2001 2002 9009008 9 9 3 5903 4395 -1508 -59181.36
2001 2002 9011004 11 9 730 5867 4364 -1503 -117501.83
2001 2002 9004008 4 9 454 6136 4646 -1490 -48264.84
2001 2002 9002008 2 9 202 5985 4496 -1489 -56963.47
2001 2002 2001001 1 9 177 6193 4729 -1464 -75154.33
2001 2002 9009002 9 9 633 5828 4378 -1450 -56879.85
2001 2002 7007001 12 9 221 6181 4735 -1446 -70024.21
2001 2002 9007004 7 9 968 6270 4824 -1446 -52481.81
2001 2002 9014002 14 9 304 6238 4795 -1443 -55308.30
2001 2002 9011002 11 9 390 6451 5027 -1424 -146066.63
2001 2002 5003001 3 9 92 5743 4329 -1414 -17800.67
2001 2002 1002001 10 9 238 5146 3737 -1409 -22597.30
2001 2002 9003002 3 9 1000 5922 4524 -1398 -23733.56
2001 2002 8015003 4 9 289 6091 4705 -1386 -25144.75
2001 2002 9006004 6 9 620 5199 3852 -1347 -60033.01
2001 2002 9008008 8 9 535 5856 4550 -1306 -82309.91
2001 2002 9002004 2 9 578 6004 4718 -1286 -56842.38
2001 2002 9010008 10 9 317 6031 4746 -1285 -58812.15
2001 2002 9014010 14 9 31 6194 4957 -1237 -8247.54
2001 2002 9010004 10 9 110 5322 4099 -1223 -104954.42
2001 2002 10005001 5 9 65 5757 4539 -1218 -42257.62
2001 2002 9013002 13 9 161 5738 4531 -1207 -43916.19
2001 2002 9007002 7 9 207 7049 5842 -1207 11539.31
2001 2002 9013002 13 9 76 5338 4132 -1206 -74962.69
2001 2002 9005008 5 9 557 5573 4377 -1196 -73326.84
2001 2002 5002001 2 9 230 6642 5460 -1182 -75568.61
2001 2002 1001001 5 9 172 5732 4567 -1165 -86618.26
2001 2002 9012008 12 9 377 5618 4464 -1154 -71600.71
2001 2002 9008002 8 9 539 6057 4909 -1148 -58233.97
2001 2002 9008008 8 9 1 5103 3966 -1137 -92689.44
2001 2002 9015002 15 9 303 6113 4980 -1133 -39501.53
2001 2002 9010002 10 9 242 5575 4446 -1129 -30983.11
2001 2002 4004001 4 9 138 6044 4921 -1123 -48818.36
2001 2002 4004001 10 9 105 6061 4940 -1121 -29300.45
2001 2002 9013010 13 9 288 5731 4618 -1113 -89316.19
2001 2002 9003004 3 9 25 6332 5220 -1112 -40286.67
2001 2002 2001001 1 9 53 6041 4931 -1110 1510.31
2001 2002 9014010 2 9 727 6186 5084 -1102 -12417.18
2001 2002 9016010 16 9 140 5966 4867 -1099 -37568.83
2001 2002 9007008 7 9 766 4885 3791 -1094 -58206.56
2001 2002 9010004 3 9 948 5325 4246 -1079 -102933.47
2001 2002 7014009 1 9 270 5641 4573 -1068 -34073.81
2001 2002 9010008 10 9 9 5647 4584 -1063 -26049.75
2001 2002 2004001 4 9 178 5664 4607 -1057 -22015.07
2001 2002 10002014 1 9 12 5230 4175 -1055 -120668.12
2001 2002 9005002 5 9 226 6772 5724 -1048 -90289.97
2001 2002 9012008 12 9 879 5586 4553 -1033 -6631.28
2001 2002 9011008 11 9 77 5402 4370 -1032 -75297.60
2001 2002 9001002 1 9 812 6067 5051 -1016 -105166.18
2001 2002 9008010 8 9 593 5372 4366 -1006 -14403.22
2001 2002 9005002 5 9 35 5869 4869 -1000 -43514.65
2001 2002 9009004 12 9 755 5751 4765 -986 12808.31
2001 2002 7004005 4 9 156 6010 5034 -976 46147.83
2001 2002 9010010 10 9 352 6340 5367 -973 -51283.74
2001 2002 9004002 4 9 515 5338 4368 -970 -48595.80
2001 2002 9015002 15 9 531 5704 4741 -963 -42865.46
2001 2002 6015001 15 9 543 5012 4051 -961 -61709.33
2001 2002 9013008 13 9 383 5662 4710 -952 -64733.88
2001 2002 9016010 16 9 662 5432 4485 -947 -20364.73
2001 2002 4002001 2 9 891 6032 5089 -943 -78697.18
2001 2002 10011013 11 9 123 5336 4406 -930 -87959.96
2001 2002 9012008 12 9 583 5392 4465 -927 -14222.65
2001 2002 7004003 10 9 274 5580 4654 -926 -14969.34
2001 2002 9015002 15 9 979 5386 4461 -925 -49108.47
2001 2002 5002001 2 9 189 5814 4893 -921 -42550.13
2001 2002 4001001 15 9 42 5377 4458 -919 -31638.02
2001 2002 1004001 4 9 286 5461 4544 -917 -48888.21
2001 2002 9005002 5 9 498 5738 4825 -913 21381.52
2001 2002 5001001 10 9 136 5780 4870 -910 -16443.31
2001 2002 8013001 13 9 17 5323 4426 -897 -16213.79
2001 2002 8002001 13 9 268 5221 4332 -889 -82807.13
2001 2002 9004008 4 9 256 5617 4744 -873 -21933.61
2001 2002 9001002 1 9 311 5275 4403 -872 -31535.40
2001 2002 9008010 2 9 954 5579 4718 -861 -15482.73
2001 2002 9013008 13 9 95 5658 4797 -861 -3222.53
2001 2002 9012004 8 9 306 5664 4811 -853 -58460.57
2001 2002 8007009 9 9 322 5477 4633 -844 -49227.26
2001 2002 9005002 5 9 565 6227 5383 -844 -44629.69
2001 2002 9012002 12 9 622 5754 4911 -843 -52169.71
2001 2002 9014004 6 9 313 5087 4247 -840 -29826.53
2001 2002 9006008 6 9 20 5239 4401 -838 9089.09
2001 2002 9001002 1 9 519 5189 4352 -837 -1173.87
2001 2002 9007008 7 9 122 5694 4858 -836 -33392.20
2001 2002 9007002 7 9 306 5541 4721 -820 -24705.64
2001 2002 9004012 4 9 621 5824 5005 -819 5754.68
2001 2002 9010002 10 9 189 5826 5030 -796 -87415.20


