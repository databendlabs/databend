# Q51
query I
WITH web_v1 AS
  (SELECT ws_item_sk item_sk,
          d_date,
          sum(sum(ws_sales_price)) OVER (PARTITION BY ws_item_sk
                                         ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) cume_sales
   FROM web_sales,
        date_dim
   WHERE ws_sold_date_sk=d_date_sk
     AND d_month_seq BETWEEN 1200 AND 1200+11
     AND ws_item_sk IS NOT NULL
   GROUP BY ws_item_sk,
            d_date),
     store_v1 AS
  (SELECT ss_item_sk item_sk,
          d_date,
          sum(sum(ss_sales_price)) OVER (PARTITION BY ss_item_sk
                                         ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) cume_sales
   FROM store_sales,
        date_dim
   WHERE ss_sold_date_sk=d_date_sk
     AND d_month_seq BETWEEN 1200 AND 1200+11
     AND ss_item_sk IS NOT NULL
   GROUP BY ss_item_sk,
            d_date)
SELECT *
FROM
  (SELECT item_sk,
          d_date,
          web_sales,
          store_sales,
          max(web_sales) OVER (PARTITION BY item_sk
                               ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) web_cumulative,
                              max(store_sales) OVER (PARTITION BY item_sk
                                                     ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) store_cumulative
   FROM
     (SELECT CASE
                 WHEN web.item_sk IS NOT NULL THEN web.item_sk
                 ELSE store.item_sk
             END item_sk,
             CASE
                 WHEN web.d_date IS NOT NULL THEN web.d_date
                 ELSE store.d_date
             END d_date,
             web.cume_sales web_sales,
             store.cume_sales store_sales
      FROM web_v1 web
      FULL OUTER JOIN store_v1 store ON (web.item_sk = store.item_sk
                                         AND web.d_date = store.d_date))x)y
WHERE web_cumulative > store_cumulative
ORDER BY item_sk NULLS FIRST,
         d_date NULLS FIRST
LIMIT 100;
----
5 2000-01-25 193.18 NULL 193.18 93.88
5 2000-01-29 NULL 162.45 193.18 162.45
5 2000-01-31 NULL 184.53 193.18 184.53
5 2000-02-23 NULL 189.68 193.18 189.68
11 2000-03-05 151.26 NULL 151.26 94.43
14 2000-01-10 135.98 NULL 135.98 73.88
14 2000-01-29 141.97 NULL 141.97 73.88
14 2000-02-02 188.37 NULL 188.37 73.88
14 2000-02-08 NULL 132.92 188.37 132.92
14 2000-02-19 NULL 136.67 188.37 136.67
14 2000-02-21 232.68 NULL 232.68 136.67
14 2000-02-22 NULL 167.46 232.68 167.46
14 2000-03-28 457.10 NULL 457.10 243.42
14 2000-03-31 462.73 NULL 462.73 243.42
14 2000-04-05 NULL 248.54 462.73 248.54
14 2000-04-15 558.42 NULL 558.42 248.54
14 2000-04-27 NULL 252.33 558.42 252.33
14 2000-05-03 NULL 318.57 558.42 318.57
14 2000-05-10 558.81 NULL 558.81 318.57
14 2000-05-21 NULL 322.10 558.81 322.10
14 2000-05-26 696.78 NULL 696.78 322.10
14 2000-05-29 NULL 322.10 696.78 322.10
14 2000-06-20 NULL 365.27 696.78 365.27
14 2000-07-03 719.18 NULL 719.18 365.27
14 2000-07-07 NULL 417.26 719.18 417.26
14 2000-07-18 NULL 430.50 719.18 430.50
14 2000-07-25 861.03 NULL 861.03 430.50
14 2000-08-10 NULL 436.52 861.03 436.52
14 2000-08-14 NULL 473.95 861.03 473.95
14 2000-08-21 NULL 507.13 861.03 507.13
14 2000-08-26 NULL 509.91 861.03 509.91
14 2000-08-28 NULL 575.33 861.03 575.33
14 2000-08-31 NULL 647.81 861.03 647.81
14 2000-09-01 NULL 700.73 861.03 700.73
14 2000-09-02 914.24 767.83 914.24 767.83
14 2000-09-03 NULL 844.80 914.24 844.80
19 2000-01-02 171.64 57.07 171.64 57.07
20 2000-01-09 37.64 NULL 37.64 7.25
25 2000-01-28 145.80 NULL 145.80 37.63
25 2000-02-09 NULL 40.98 145.80 40.98
25 2000-02-11 NULL 139.21 145.80 139.21
25 2000-02-21 NULL 143.19 145.80 143.19
32 2000-02-22 76.51 NULL 76.51 53.06
35 2000-01-14 NULL 40.94 95.44 40.94
37 2000-01-02 106.22 43.81 106.22 43.81
37 2000-01-04 NULL 106.03 106.22 106.03
37 2000-01-05 136.71 NULL 136.71 106.03
37 2000-01-06 NULL 111.82 136.71 111.82
37 2000-01-24 NULL 134.51 136.71 134.51
37 2000-02-04 176.29 NULL 176.29 145.13
37 2000-02-07 NULL 145.13 176.29 145.13
37 2000-02-26 NULL 149.83 176.29 149.83
37 2000-03-14 NULL 161.01 176.29 161.01
37 2000-03-15 NULL 164.40 176.29 164.40
37 2000-03-16 NULL 164.40 176.29 164.40
37 2000-03-21 203.97 NULL 203.97 164.40
37 2000-04-03 208.51 NULL 208.51 164.40
37 2000-04-05 263.04 NULL 263.04 164.40
37 2000-04-07 367.78 NULL 367.78 164.40
37 2000-04-10 NULL 203.26 367.78 203.26
37 2000-05-04 446.26 NULL 446.26 203.26
37 2000-05-09 NULL 300.02 446.26 300.02
37 2000-05-13 507.85 NULL 507.85 300.02
37 2000-05-23 NULL 319.79 507.85 319.79
37 2000-06-21 NULL 355.11 507.85 355.11
37 2000-06-26 NULL 392.21 507.85 392.21
37 2000-07-15 NULL 394.18 507.85 394.18
37 2000-07-17 NULL 396.94 507.85 396.94
37 2000-07-24 519.67 NULL 519.67 396.94
37 2000-08-04 NULL 507.14 519.67 507.14
37 2000-08-13 NULL 512.20 519.67 512.20
37 2000-08-14 NULL 518.76 519.67 518.76
41 2000-01-21 NULL 72.70 115.36 72.70
47 2000-01-19 NULL 95.71 113.23 95.71
47 2000-02-17 146.76 NULL 146.76 146.27
53 2000-01-08 38.38 NULL 38.38 7.50
53 2000-01-09 61.72 NULL 61.72 7.50
53 2000-01-15 NULL 31.20 61.72 31.20
61 2000-01-02 64.44 7.73 64.44 7.73
61 2000-01-07 79.56 33.81 79.56 33.81
61 2000-02-17 257.98 NULL 257.98 189.63
61 2000-03-01 NULL 240.65 257.98 240.65
65 2000-01-03 71.96 NULL 71.96 66.75
68 2000-01-19 14.25 NULL 14.25 6.38
68 2000-01-21 NULL 8.61 14.25 8.61
71 2000-01-02 35.36 2.26 35.36 2.26
71 2000-01-11 NULL 6.59 35.36 6.59
86 2000-01-19 83.91 NULL 83.91 2.39
98 2000-01-18 20.64 NULL 20.64 20.14
98 2000-03-29 233.74 NULL 233.74 219.29
98 2000-04-23 462.63 284.52 462.63 284.52
98 2000-05-01 NULL 413.39 462.63 413.39
98 2000-05-06 NULL 438.37 462.63 438.37
101 2000-01-27 NULL 51.36 102.93 51.36
101 2000-02-07 147.16 NULL 147.16 51.36
101 2000-05-02 411.55 NULL 411.55 367.06
101 2000-05-12 418.18 NULL 418.18 367.06
101 2000-06-19 576.37 NULL 576.37 522.55
110 2000-01-16 NULL 2.66 91.38 2.66
110 2000-01-21 NULL 80.55 91.38 80.55


