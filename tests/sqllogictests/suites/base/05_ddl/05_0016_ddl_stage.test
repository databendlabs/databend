statement ok
DROP STAGE IF EXISTS test_stage

statement ok
DROP STAGE IF EXISTS test_stage_internal

statement ok
CREATE STAGE test_stage url='s3://load/files/' connection=(aws_key_id='1a2b3c' aws_secret_key='4x5y6z')

statement ok
CREATE STAGE if not exists test_stage url='s3://load/files/' connection=(access_key_id='1a2b3c' aws_secret_key='4x5y6z')

statement error 2502
CREATE STAGE test_stage url='s3://load/files/' connection=(aws_key_id='1a2b3c' aws_secret_key='4x5y6z')

statement ok
CREATE STAGE test_stage_internal file_format=(type=csv compression=AUTO record_delimiter='\n' escape='\\') comments='test'

statement ok
LIST @test_stage_internal

statement ok
desc stage test_stage_internal

statement ok
SHOW STAGES

query III
copy into @test_stage_internal from (select 1) file_format=(type=csv)
----
1 2 2

query I
select count(*) from  list_stage(location=>'@test_stage_internal')
----
1


statement ok
create or replace stage test_stage_internal

# files should be removed
query TITTT
list @test_stage_internal
----

statement ok
DROP STAGE test_stage

statement ok
DROP STAGE test_stage_internal

statement ok
CREATE STAGE if not exists test_stage_huggingface url='hf://opendal/huggingface-testdata/'

statement ok
DROP STAGE test_stage_huggingface

statement ok
CREATE STAGE if not exists test_stage_cos url='cos://testbucket/' connection=(secret_id ='minioadmin' secret_key ='minioadmin' endpoint_url='https://cos.ap-guangzhou.myqcloud.com')

statement ok
DROP STAGE test_stage_cos

statement ok
CREATE STAGE if not exists replace_test_stage_huggingface url='hf://opendal/huggingface-testdata/'

statement error 1005
CREATE OR REPLACE STAGE if not exists replace_test_stage_huggingface url='hf://opendal/huggingface-testdata/'

statement ok
CREATE OR REPLACE STAGE replace_test_stage_huggingface url='hf://opendal/huggingface-testdata/'

statement ok
DROP STAGE replace_test_stage_huggingface

statement ok
SHOW STAGES

statement ok
create or replace stage s;

statement ok
create table t(c int);

statement ok
insert into t values(1);

statement ok
copy into @s from t;

statement ok
create or replace stage s;

query I
select * from @s;
----

statement ok
DROP STAGE s;

statement ok
drop table t;

statement ok
CREATE STAGE alter_stage_internal;

statement ok
ALTER STAGE alter_stage_internal SET FILE_FORMAT = (TYPE = CSV), COMMENT = 'altered';

query T
SELECT comment FROM system.stages WHERE name = 'alter_stage_internal';
----
altered

query B
SELECT json_extract_path_text(to_string(file_format_options), 'type') = 'Csv'
FROM system.stages WHERE name = 'alter_stage_internal';
----
1

statement ok
ALTER STAGE alter_stage_internal UNSET COMMENT, FILE_FORMAT;

query B
SELECT comment = '' FROM system.stages WHERE name = 'alter_stage_internal';
----
1

query B
SELECT json_extract_path_text(to_string(file_format_options), 'type') = 'Parquet'
FROM system.stages WHERE name = 'alter_stage_internal';
----
1

statement ok
CREATE STAGE alter_stage_external url='fs:///';

statement ok
ALTER STAGE alter_stage_external SET URL = 'fs:///tmp/';

query T
SELECT url FROM system.stages WHERE name = 'alter_stage_external';
----
fs:///tmp/

statement ok
ALTER STAGE IF EXISTS missing_stage SET COMMENT = 'noop';

statement ok
DROP STAGE alter_stage_internal;

statement ok
DROP STAGE alter_stage_external;
