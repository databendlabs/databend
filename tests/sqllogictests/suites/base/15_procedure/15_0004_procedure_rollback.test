statement ok
set global enable_experimental_procedure=1;

statement ok
create or replace table t_rollback_1 (str varchar);

statement ok
drop procedure if exists test_rollback_on_error();

# Test procedure with automatic rollback on division by zero error
statement ok
CREATE PROCEDURE test_rollback_on_error() RETURNS int not null LANGUAGE SQL AS $$
BEGIN
    insert into t_rollback_1 (str) values ('a'), ('b');
    select 1/0;
    RETURN 1;
END;
$$;

# Test error causes rollback - data should not be inserted
statement error
begin;
call procedure test_rollback_on_error();
commit;

query I
select * from t_rollback_1;
----


statement ok
create or replace table t_rollback_1 (str varchar);

statement ok
drop procedure if exists test_rollback_on_syntax_error();

# Test procedure with automatic rollback on syntax error
statement ok
CREATE PROCEDURE test_rollback_on_syntax_error() RETURNS int not null LANGUAGE SQL AS $$
BEGIN
    insert into t_rollback_1 (str) values ('a'), ('b');
    1;
    RETURN 1;
END;
$$;

# Test syntax error causes rollback - data should not be inserted
statement error
begin;
call procedure test_rollback_on_syntax_error();
commit;

query I
select * from t_rollback_1;
----


statement ok
create or replace table t_rollback_1 (str varchar);

statement ok
drop procedure if exists test_rollback_on_column_error();

# Test procedure with automatic rollback on non-existent column error
statement ok
CREATE PROCEDURE test_rollback_on_column_error() RETURNS int not null LANGUAGE SQL AS $$
BEGIN
    insert into t_rollback_1 (str) values ('a'), ('b');
    select nonexistent from t_rollback_1;
    RETURN 1;
END;
$$;

# Test column error causes rollback - data should not be inserted
statement error
begin;
call procedure test_rollback_on_column_error();
commit;

query I
select * from t_rollback_1;
----


statement ok
drop procedure if exists test_rollback_on_error();

statement ok
drop procedure if exists test_rollback_on_syntax_error();

statement ok
drop procedure if exists test_rollback_on_column_error();

statement ok
drop table t_rollback_1;
