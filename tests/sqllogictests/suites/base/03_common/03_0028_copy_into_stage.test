statement ok
DROP DATABASE IF EXISTS db1

statement ok
CREATE DATABASE db1

statement ok
USE db1

statement ok
CREATE TABLE test_table(id INTEGER, name VARCHAR, age INT)

statement ok
insert into test_table (id,name,age) values (1,'2',3), (4, '5', 6)

statement ok
DROP STAGE IF EXISTS test

statement ok
CREATE STAGE IF NOT EXISTS test

statement ok
copy into @test from test_table FILE_FORMAT = (type = CSV)

statement ok
copy into test_table from @test FILE_FORMAT = (type = CSV)

query I
SELECT COUNT() FROM test_table
----
4

statement ok
drop table test_table all

statement ok
drop stage test

statement ok
DROP STAGE IF EXISTS hello

statement ok
CREATE STAGE IF NOT EXISTS hello

statement ok
COPY INTO @hello from (select number from numbers(10)) FILE_FORMAT = (type = parquet)

statement ok
COPY INTO @hello from (select number from numbers(1) where number in  (select max(number) from numbers(1000)) ) FILE_FORMAT = (type = parquet)

statement ok
with S as (select number from numbers(1000) where number > 100) COPY INTO @hello from (select number from numbers(1) where number not in (SELECT number FROM S)) FILE_FORMAT = (type = parquet)

query I
select sum(number) from @hello;
----
45


statement ok
remove @hello

statement ok
create or replace table abc(number int, item Tuple(name String, age int)) as select number, ('aa', number) from numbers(10);

statement ok
COPY INTO @hello from (select * from abc) FILE_FORMAT = (type = parquet)

query TI
select max(item['name']), sum(item['age']) from @hello;
----
aa 45

statement ok
CREATE TABLE world(c1 int , c2 int);

statement error (?s)1006.*Number of columns in select list \(1\) does not match that of the corresponding table \(2\)
COPY INTO world FROM (select number  from @hello )   file_format = (type = PARQUET);

statement ok
DROP STAGE IF EXISTS hello

statement ok
drop table if EXISTS abc

statement ok
drop table if EXISTS world

statement ok
CREATE TABLE stage_partition_src(dt DATE, ts TIMESTAMP, val INT)

statement ok
INSERT INTO stage_partition_src VALUES
    ('2020-01-28', '2020-01-28 18:00:00', 1),
    ('2020-01-28', '2020-01-28 22:00:00', 2),
    ('2020-01-29', '2020-01-29 02:00:00', 3),
    (NULL, NULL, 4)

statement ok
DROP STAGE IF EXISTS hello_partition

statement ok
CREATE STAGE hello_partition

statement ok
COPY INTO @hello_partition
    FROM stage_partition_src
    PARTITION BY ('date=' || to_varchar(dt, 'YYYY-MM-DD') || '/hour=' || lpad(to_varchar(date_part('hour', ts)), 2, '0'))
    FILE_FORMAT = (type = PARQUET)

query TTTT
SELECT
    count_if(name LIKE 'date=2020-01-28/hour=18/%'),
    count_if(name LIKE 'date=2020-01-28/hour=22/%'),
    count_if(name LIKE 'date=2020-01-29/hour=02/%'),
    count_if(name LIKE '_NULL_/%')
FROM list_stage(location=>'@hello_partition')
----
1 1 1 1

statement ok
DROP STAGE hello_partition


statement ok
DROP DATABASE db1