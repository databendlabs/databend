## Copyright 2023 Databend Cloud
##
## Licensed under the Elastic License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
##     https://www.elastic.co/licensing/elastic-license
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.

# Test: system.tables and system.views should correctly filter view/stream
# when using the optimized path (db_count * table_count <= 20).
# This test ensures that:
# 1. system.tables does not include stream tables
# 2. system.views only includes views (not base tables or streams)

statement ok
DROP DATABASE IF EXISTS test_sys_filter

statement ok
CREATE DATABASE test_sys_filter

statement ok
USE test_sys_filter

# Create a base table
statement ok
CREATE TABLE t1(a int)

statement ok
INSERT INTO t1 VALUES(1)

# Enable change tracking for stream
statement ok
ALTER TABLE t1 SET OPTIONS(change_tracking=true)

# Create a stream on t1
statement ok
CREATE STREAM s1 ON TABLE t1

# Create a view
statement ok
CREATE VIEW v1 AS SELECT * FROM t1

# Test 1: system.tables should show t1 and v1 but NOT s1
# Using specific database and name filters (with OR) to hit optimized path
# Note: must use name = 'x' OR name = 'y' form, not IN (...), to be extracted by eq filters
query TT rowsort
SELECT name, engine FROM system.tables WHERE database = 'test_sys_filter' AND (name = 't1' OR name = 's1' OR name = 'v1')
----
t1 FUSE
v1 VIEW

# Test 2: system.views should only show v1 (not t1 or s1)
query T
SELECT name FROM system.views WHERE database = 'test_sys_filter' AND (name = 't1' OR name = 's1' OR name = 'v1')
----
v1

# Test 3: Verify system.tables count excludes stream
query I
SELECT count(*) FROM system.tables WHERE database = 'test_sys_filter'
----
2

# Test 4: Verify system.views count
query I
SELECT count(*) FROM system.views WHERE database = 'test_sys_filter'
----
1

# Cleanup
statement ok
DROP STREAM IF EXISTS s1

statement ok
DROP VIEW IF EXISTS v1

statement ok
DROP TABLE IF EXISTS t1

statement ok
DROP DATABASE IF EXISTS test_sys_filter
