statement ok
USE default

statement ok
set hide_options_in_show_create_table=1

# no rewrite: int32 -> int64 (block locations unchanged + data readable)
statement ok
drop table if exists alter_no_rewrite_t_int

statement ok
create table alter_no_rewrite_t_int(a int null)

statement ok
insert into alter_no_rewrite_t_int values (1), (2), (3)

statement ok
drop table if exists alter_no_rewrite_loc_int

statement ok
create table alter_no_rewrite_loc_int(block_location string)

statement ok
insert into alter_no_rewrite_loc_int select block_location from fuse_block('default','alter_no_rewrite_t_int')

statement ok
alter table alter_no_rewrite_t_int modify column a bigint null

# verify no rewrite: block locations unchanged after widening
query IIII
select
  (select count(*) from fuse_block('default','alter_no_rewrite_t_int')) as after_cnt,
  (select count(*) from alter_no_rewrite_loc_int) as before_cnt,
  (select count(*) from (
    select block_location from alter_no_rewrite_loc_int
    except
    select block_location from fuse_block('default','alter_no_rewrite_t_int')
  )) as missing_from_after,
  (select count(*) from (
    select block_location from fuse_block('default','alter_no_rewrite_t_int')
    except
    select block_location from alter_no_rewrite_loc_int
  )) as new_in_after
----
1 1 0 0

query I
select a from alter_no_rewrite_t_int order by a
----
1
2
3

query T
select data_type from system.columns where database = 'default' and table = 'alter_no_rewrite_t_int' and name = 'a'
----
BIGINT

# no rewrite: decimal precision widen (scale unchanged, values preserved)
statement ok
drop table if exists alter_no_rewrite_t_dec

statement ok
create table alter_no_rewrite_t_dec(a decimal(10, 2) null)

statement ok
insert into alter_no_rewrite_t_dec values (1.23), (4.56)

statement ok
drop table if exists alter_no_rewrite_loc_dec

statement ok
create table alter_no_rewrite_loc_dec(block_location string)

statement ok
insert into alter_no_rewrite_loc_dec select block_location from fuse_block('default','alter_no_rewrite_t_dec')

statement ok
alter table alter_no_rewrite_t_dec modify column a decimal(20, 2) null

# verify no rewrite: block locations unchanged after widening
query IIII
select
  (select count(*) from fuse_block('default','alter_no_rewrite_t_dec')) as after_cnt,
  (select count(*) from alter_no_rewrite_loc_dec) as before_cnt,
  (select count(*) from (
    select block_location from alter_no_rewrite_loc_dec
    except
    select block_location from fuse_block('default','alter_no_rewrite_t_dec')
  )) as missing_from_after,
  (select count(*) from (
    select block_location from fuse_block('default','alter_no_rewrite_t_dec')
    except
    select block_location from alter_no_rewrite_loc_dec
  )) as new_in_after
----
1 1 0 0

query R
select a from alter_no_rewrite_t_dec order by a
----
1.23
4.56

query T
select data_type from system.columns where database = 'default' and table = 'alter_no_rewrite_t_dec' and name = 'a'
----
DECIMAL(20, 2)

# rename column keeps dfs leaf order (no rewrite) and allows widening
statement ok
drop table if exists alter_no_rewrite_rename

statement ok
create table alter_no_rewrite_rename(a int, b int)

statement ok
insert into alter_no_rewrite_rename values (1, 10), (2, 20)

statement ok
drop table if exists alter_no_rewrite_loc_rename

statement ok
create table alter_no_rewrite_loc_rename(block_location string)

statement ok
insert into alter_no_rewrite_loc_rename select block_location from fuse_block('default','alter_no_rewrite_rename')

statement ok
alter table alter_no_rewrite_rename rename column b to x

statement ok
alter table alter_no_rewrite_rename modify column x bigint

# verify no rewrite: block locations unchanged after rename + widening
query IIII
select
  (select count(*) from fuse_block('default','alter_no_rewrite_rename')) as after_cnt,
  (select count(*) from alter_no_rewrite_loc_rename) as before_cnt,
  (select count(*) from (
    select block_location from alter_no_rewrite_loc_rename
    except
    select block_location from fuse_block('default','alter_no_rewrite_rename')
  )) as missing_from_after,
  (select count(*) from (
    select block_location from fuse_block('default','alter_no_rewrite_rename')
    except
    select block_location from alter_no_rewrite_loc_rename
  )) as new_in_after
----
1 1 0 0

query II
select a, x from alter_no_rewrite_rename order by a
----
1 10
2 20

query T
select data_type from system.columns where database = 'default' and table = 'alter_no_rewrite_rename' and name = 'x'
----
BIGINT

# drop column keeps remaining leaf mapping (no rewrite for widening)
statement ok
drop table if exists alter_no_rewrite_drop

statement ok
create table alter_no_rewrite_drop(a int, b int, c int)

statement ok
insert into alter_no_rewrite_drop values (1, 10, 100), (2, 20, 200)

statement ok
drop table if exists alter_no_rewrite_loc_drop

statement ok
create table alter_no_rewrite_loc_drop(block_location string)

statement ok
insert into alter_no_rewrite_loc_drop select block_location from fuse_block('default','alter_no_rewrite_drop')

statement ok
alter table alter_no_rewrite_drop drop column b

statement ok
alter table alter_no_rewrite_drop modify column c bigint

# verify no rewrite: block locations unchanged after drop + widening
query IIII
select
  (select count(*) from fuse_block('default','alter_no_rewrite_drop')) as after_cnt,
  (select count(*) from alter_no_rewrite_loc_drop) as before_cnt,
  (select count(*) from (
    select block_location from alter_no_rewrite_loc_drop
    except
    select block_location from fuse_block('default','alter_no_rewrite_drop')
  )) as missing_from_after,
  (select count(*) from (
    select block_location from fuse_block('default','alter_no_rewrite_drop')
    except
    select block_location from alter_no_rewrite_loc_drop
  )) as new_in_after
----
1 1 0 0

query II
select a, c from alter_no_rewrite_drop order by a
----
1 100
2 200

query T
select data_type from system.columns where database = 'default' and table = 'alter_no_rewrite_drop' and name = 'c'
----
BIGINT

# decimal scale change should trigger rewrite (incompatible change)
statement ok
drop table if exists alter_rewrite_dec_scale

statement ok
create table alter_rewrite_dec_scale(a decimal(10, 2))

statement ok
insert into alter_rewrite_dec_scale values (1.23), (4.56)

statement ok
drop table if exists alter_rewrite_loc_dec_scale

statement ok
create table alter_rewrite_loc_dec_scale(block_location string)

statement ok
insert into alter_rewrite_loc_dec_scale select block_location from fuse_block('default','alter_rewrite_dec_scale')

statement ok
alter table alter_rewrite_dec_scale modify column a decimal(10, 3)

# verify rewrite: block locations change after scale adjustment
query IIII
select
  (select count(*) from fuse_block('default','alter_rewrite_dec_scale')) as after_cnt,
  (select count(*) from alter_rewrite_loc_dec_scale) as before_cnt,
  (select count(*) from (
    select block_location from alter_rewrite_loc_dec_scale
    except
    select block_location from fuse_block('default','alter_rewrite_dec_scale')
  )) as missing_from_after,
  (select count(*) from (
    select block_location from fuse_block('default','alter_rewrite_dec_scale')
    except
    select block_location from alter_rewrite_loc_dec_scale
  )) as new_in_after
----
1 1 1 1

query I
select count(*) from alter_rewrite_dec_scale
----
2

query T
select data_type from system.columns where database = 'default' and table = 'alter_rewrite_dec_scale' and name = 'a'
----
DECIMAL(10, 3)

query R
select cast(a as decimal(10, 2)) from alter_rewrite_dec_scale order by a
----
1.23
4.56

# range pruning after widening (plan shows pruned partitions)
statement ok
drop table if exists alter_no_rewrite_range

statement ok
create table alter_no_rewrite_range(a int)

statement ok
insert into alter_no_rewrite_range select number from numbers(1000)

statement ok
insert into alter_no_rewrite_range select number + 1000 from numbers(1000)

statement ok
insert into alter_no_rewrite_range select number + 2000 from numbers(1000)

statement ok
alter table alter_no_rewrite_range modify column a bigint

query T
explain select 1 from alter_no_rewrite_range where a = 42
----
EvalScalar
├── output columns: [1 (#1)]
├── expressions: [1]
├── estimated rows: 1.00
└── TableScan
    ├── table: default.default.alter_no_rewrite_range
    ├── scan id: 0
    ├── output columns: []
    ├── read rows: 1000
    ├── read size: 1.88 KiB
    ├── partitions total: 3
    ├── partitions scanned: 1
    ├── pruning stats: [segments: <range pruning: 3 to 1 cost: <slt:ignore>>, blocks: <range pruning: 1 to 1 cost: <slt:ignore>, bloom pruning: 1 to 1 cost: <slt:ignore>>]
    ├── push downs: [filters: [is_true(alter_no_rewrite_range.a (#0) = 42)], limit: NONE]
    └── estimated rows: 1.00

# runtime read after widening (should return matching row)
query I
select count(*) from alter_no_rewrite_range where a = 42
----
1

# bloom pruning after widening (plan shows bloom pruning + runtime read)
statement ok
drop table if exists alter_no_rewrite_bloom

statement ok
create table alter_no_rewrite_bloom(a int, b int)

statement ok
alter table alter_no_rewrite_bloom set options(bloom_index_columns = 'a')

statement ok
insert into alter_no_rewrite_bloom values (1, 1), (5, 6), (10, 10)

statement ok
insert into alter_no_rewrite_bloom values (1, 1), (7, 8), (10, 10)

statement ok
alter table alter_no_rewrite_bloom modify column a bigint

query T
explain select 1 from alter_no_rewrite_bloom where a = 5
----
EvalScalar
├── output columns: [1 (#2)]
├── expressions: [1]
├── estimated rows: 1.50
└── TableScan
    ├── table: default.default.alter_no_rewrite_bloom
    ├── scan id: 0
    ├── output columns: []
    ├── read rows: 3
    ├── read size: < 1 KiB
    ├── partitions total: 2
    ├── partitions scanned: 1
    ├── pruning stats: [segments: <range pruning: 2 to 2 cost: <slt:ignore>>, blocks: <range pruning: 2 to 2 cost: <slt:ignore>, bloom pruning: 2 to 1 cost: <slt:ignore>>]
    ├── push downs: [filters: [is_true(alter_no_rewrite_bloom.a (#0) = 5)], limit: NONE]
    └── estimated rows: 1.50

query I
select 1 from alter_no_rewrite_bloom where a = 5
----
1

# recluster after widening should succeed even when merging mixed-type stats
statement ok
drop table if exists alter_no_rewrite_recluster

statement ok
create table alter_no_rewrite_recluster(a int, b int) cluster by (a) row_per_block = 2

statement ok
insert into alter_no_rewrite_recluster values (1, 10), (2, 20), (3, 30), (4, 40)

statement ok
alter table alter_no_rewrite_recluster modify column a bigint

statement ok
alter table alter_no_rewrite_recluster recluster final

query I
select count(*) from alter_no_rewrite_recluster
----
4
