statement ok
DROP DATABASE IF EXISTS test_ngram_index_db

statement ok
CREATE DATABASE test_ngram_index_db

statement ok
USE test_ngram_index_db

statement ok
DROP TABLE IF EXISTS t1

statement ok
CREATE TABLE t1 (id int, content string) row_per_block=2 storage_format='parquet'

statement ok
CREATE NGRAM INDEX IF NOT EXISTS idx1 ON t1(content)

statement ok
INSERT INTO t1 VALUES
(1, 'The quick brown fox jumps over the lazy dog'),
(2, 'A picture is worth a thousand words'),
(3, 'The early bird catches the worm'),
(4, 'Actions speak louder than words'),
(5, 'Time flies like an arrow; fruit flies like a banana'),
(6, 'Beauty is in the eye of the beholder'),
(7, 'When life gives you lemons, make lemonade'),
(8, 'Put all your eggs in one basket'),
(9, 'You can not judge a book by its cover'),
(10, 'An apple a day keeps the doctor away'),
(11, '江火暗还明'),
(12, '孤舟枕浪轻'),
(13, '风来云欲语'),
(14, '潮退月无声'),
(15, '客梦三更短'),
(16, '乡愁一水横')

query T
EXPLAIN SELECT id, content FROM t1 WHERE content LIKE '%yo%'
----
Filter
├── output columns: [t1.id (#0), t1.content (#1)]
├── filters: [is_true(like(t1.content (#1), '%yo%'))]
├── estimated rows: 8.00
└── TableScan
    ├── table: default.test_ngram_index_db.t1
    ├── scan id: 0
    ├── output columns: [id (#0), content (#1)]
    ├── read rows: 16
    ├── read size: 1.03 KiB
    ├── partitions total: 8
    ├── partitions scanned: 8
    ├── pruning stats: [segments: <range pruning: 1 to 1 cost: <slt:ignore>>, blocks: <range pruning: 8 to 8 cost: <slt:ignore>, bloom pruning: 8 to 8 cost: <slt:ignore>>]
    ├── push downs: [filters: [is_true(like(t1.content (#1), '%yo%'))], limit: NONE]
    └── estimated rows: 16.00

query T
EXPLAIN SELECT id, content FROM t1 WHERE content LIKE '%your eggs%'
----
Filter
├── output columns: [t1.id (#0), t1.content (#1)]
├── filters: [is_true(like(t1.content (#1), '%your eggs%'))]
├── estimated rows: 0.06
└── TableScan
    ├── table: default.test_ngram_index_db.t1
    ├── scan id: 0
    ├── output columns: [id (#0), content (#1)]
    ├── read rows: 2
    ├── read size: < 1 KiB
    ├── partitions total: 8
    ├── partitions scanned: 1
    ├── pruning stats: [segments: <range pruning: 1 to 1 cost: <slt:ignore>>, blocks: <range pruning: 8 to 8 cost: <slt:ignore>, bloom pruning: 8 to 1 cost: <slt:ignore>>]
    ├── push downs: [filters: [is_true(like(t1.content (#1), '%your eggs%'))], limit: NONE]
    └── estimated rows: 16.00

query T
EXPLAIN SELECT id, content FROM t1 WHERE content LIKE '%your eggs'
----
Filter
├── output columns: [t1.id (#0), t1.content (#1)]
├── filters: [is_true(like(t1.content (#1), '%your eggs'))]
├── estimated rows: 0.03
└── TableScan
    ├── table: default.test_ngram_index_db.t1
    ├── scan id: 0
    ├── output columns: [id (#0), content (#1)]
    ├── read rows: 2
    ├── read size: < 1 KiB
    ├── partitions total: 8
    ├── partitions scanned: 1
    ├── pruning stats: [segments: <range pruning: 1 to 1 cost: <slt:ignore>>, blocks: <range pruning: 8 to 8 cost: <slt:ignore>, bloom pruning: 8 to 1 cost: <slt:ignore>>]
    ├── push downs: [filters: [is_true(like(t1.content (#1), '%your eggs'))], limit: NONE]
    └── estimated rows: 16.00

query T
EXPLAIN SELECT id, content FROM t1 WHERE content LIKE '%风来%'
----
Filter
├── output columns: [t1.id (#0), t1.content (#1)]
├── filters: [is_true(like(t1.content (#1), '%风来%'))]
├── estimated rows: 8.00
└── TableScan
    ├── table: default.test_ngram_index_db.t1
    ├── scan id: 0
    ├── output columns: [id (#0), content (#1)]
    ├── read rows: 16
    ├── read size: 1.03 KiB
    ├── partitions total: 8
    ├── partitions scanned: 8
    ├── pruning stats: [segments: <range pruning: 1 to 1 cost: <slt:ignore>>, blocks: <range pruning: 8 to 8 cost: <slt:ignore>, bloom pruning: 8 to 8 cost: <slt:ignore>>]
    ├── push downs: [filters: [is_true(like(t1.content (#1), '%风来%'))], limit: NONE]
    └── estimated rows: 16.00

query T
EXPLAIN SELECT id, content FROM t1 WHERE content LIKE '%月无声%'
----
Filter
├── output columns: [t1.id (#0), t1.content (#1)]
├── filters: [is_true(like(t1.content (#1), '%月无声%'))]
├── estimated rows: 4.00
└── TableScan
    ├── table: default.test_ngram_index_db.t1
    ├── scan id: 0
    ├── output columns: [id (#0), content (#1)]
    ├── read rows: 2
    ├── read size: < 1 KiB
    ├── partitions total: 8
    ├── partitions scanned: 1
    ├── pruning stats: [segments: <range pruning: 1 to 1 cost: <slt:ignore>>, blocks: <range pruning: 8 to 8 cost: <slt:ignore>, bloom pruning: 8 to 1 cost: <slt:ignore>>]
    ├── push downs: [filters: [is_true(like(t1.content (#1), '%月无声%'))], limit: NONE]
    └── estimated rows: 16.00

query T
SELECT id, content FROM t1 WHERE content LIKE '%your eggs%'
----
8 Put all your eggs in one basket

statement ok
DROP TABLE IF EXISTS t2

statement ok
CREATE TABLE t2 (id int, content string) row_per_block=2 storage_format='native'

statement ok
CREATE NGRAM INDEX IF NOT EXISTS idx1 ON t2(content)

statement ok
INSERT INTO t2 VALUES
(1, 'The quick brown fox jumps over the lazy dog'),
(2, 'A picture is worth a thousand words'),
(3, 'The early bird catches the worm'),
(4, 'Actions speak louder than words'),
(5, 'Time flies like an arrow; fruit flies like a banana'),
(6, 'Beauty is in the eye of the beholder'),
(7, 'When life gives you lemons, make lemonade'),
(8, 'Put all your eggs in one basket'),
(9, 'You can not judge a book by its cover'),
(10, 'An apple a day keeps the doctor away'),
(11, '江火暗还明'),
(12, '孤舟枕浪轻'),
(13, '风来云欲语'),
(14, '潮退月无声'),
(15, '客梦三更短'),
(16, '乡愁一水横')

query T
EXPLAIN SELECT id, content FROM t2 WHERE content LIKE '%your eggs%'
----
TableScan
├── table: default.test_ngram_index_db.t2
├── scan id: 0
├── output columns: [id (#0), content (#1)]
├── read rows: 2
├── read size: < 1 KiB
├── partitions total: 8
├── partitions scanned: 1
├── pruning stats: [segments: <range pruning: 1 to 1 cost: <slt:ignore>>, blocks: <range pruning: 8 to 8 cost: <slt:ignore>, bloom pruning: 8 to 1 cost: <slt:ignore>>]
├── push downs: [filters: [is_true(like(t2.content (#1), '%your eggs%'))], limit: NONE]
└── estimated rows: 0.06

query T
EXPLAIN SELECT id, content FROM t2 WHERE content LIKE '%your eggs'
----
TableScan
├── table: default.test_ngram_index_db.t2
├── scan id: 0
├── output columns: [id (#0), content (#1)]
├── read rows: 2
├── read size: < 1 KiB
├── partitions total: 8
├── partitions scanned: 1
├── pruning stats: [segments: <range pruning: 1 to 1 cost: <slt:ignore>>, blocks: <range pruning: 8 to 8 cost: <slt:ignore>, bloom pruning: 8 to 1 cost: <slt:ignore>>]
├── push downs: [filters: [is_true(like(t2.content (#1), '%your eggs'))], limit: NONE]
└── estimated rows: 0.03

query T
SELECT id, content FROM t1 WHERE content LIKE '%your eggs%'
----
8 Put all your eggs in one basket

query T
EXPLAIN SELECT id, content FROM t2 WHERE content LIKE '%yo%'
----
TableScan
├── table: default.test_ngram_index_db.t2
├── scan id: 0
├── output columns: [id (#0), content (#1)]
├── read rows: 16
├── read size: 1.26 KiB
├── partitions total: 8
├── partitions scanned: 8
├── pruning stats: [segments: <range pruning: 1 to 1 cost: <slt:ignore>>, blocks: <range pruning: 8 to 8 cost: <slt:ignore>, bloom pruning: 8 to 8 cost: <slt:ignore>>]
├── push downs: [filters: [is_true(like(t2.content (#1), '%yo%'))], limit: NONE]
└── estimated rows: 8.00

query T
EXPLAIN SELECT id, content FROM t2 WHERE content LIKE '%风来%'
----
TableScan
├── table: default.test_ngram_index_db.t2
├── scan id: 0
├── output columns: [id (#0), content (#1)]
├── read rows: 16
├── read size: 1.26 KiB
├── partitions total: 8
├── partitions scanned: 8
├── pruning stats: [segments: <range pruning: 1 to 1 cost: <slt:ignore>>, blocks: <range pruning: 8 to 8 cost: <slt:ignore>, bloom pruning: 8 to 8 cost: <slt:ignore>>]
├── push downs: [filters: [is_true(like(t2.content (#1), '%风来%'))], limit: NONE]
└── estimated rows: 8.00

query T
EXPLAIN SELECT id, content FROM t2 WHERE content LIKE '%月无声%'
----
TableScan
├── table: default.test_ngram_index_db.t2
├── scan id: 0
├── output columns: [id (#0), content (#1)]
├── read rows: 2
├── read size: < 1 KiB
├── partitions total: 8
├── partitions scanned: 1
├── pruning stats: [segments: <range pruning: 1 to 1 cost: <slt:ignore>>, blocks: <range pruning: 8 to 8 cost: <slt:ignore>, bloom pruning: 8 to 1 cost: <slt:ignore>>]
├── push downs: [filters: [is_true(like(t2.content (#1), '%月无声%'))], limit: NONE]
└── estimated rows: 4.00

# Tests whether the ngram index with the same column and the same parameters
# will use the old index after the column is removed
statement ok
DROP ngram INDEX idx1 ON t2

statement ok
ALTER TABLE t2 DROP COLUMN content;

statement ok
ALTER TABLE t2 ADD COLUMN content string;

statement ok
INSERT INTO t2 VALUES
(17, 'The quick brown fox jumps over the lazy dog'),
(18, 'A picture is worth a thousand words'),
(19, 'The early bird catches the worm'),
(20, 'Actions speak louder than words'),
(21, 'Time flies like an arrow; fruit flies like a banana'),
(22, 'Beauty is in the eye of the beholder'),
(23, 'When life gives you lemons, make lemonade'),
(24, 'Put all your eggs in one basket'),
(25, 'You can not judge a book by its cover'),
(26, 'An apple a day keeps the doctor away')

query T
EXPLAIN SELECT id, content FROM t2 WHERE content LIKE '%your eggs%'
----
TableScan
├── table: default.test_ngram_index_db.t2
├── scan id: 0
├── output columns: [id (#0), content (#1)]
├── read rows: 10
├── read size: < 1 KiB
├── partitions total: 2
├── partitions scanned: 5
├── pruning stats: [segments: <range pruning: 2 to 2 cost: <slt:ignore>>, blocks: <range pruning: 13 to 5 cost: <slt:ignore>>]
├── push downs: [filters: [is_true(like(t2.content (#1), '%your eggs%'))], limit: NONE]
└── estimated rows: 0.10

statement ok
CREATE NGRAM INDEX IF NOT EXISTS idx1 ON t2(content)

statement ok
INSERT INTO t2 VALUES (27, 'The Anthem of man is the Anthem of courage')

query T
EXPLAIN SELECT id, content FROM t2 WHERE content LIKE '%your eggs%'
----
TableScan
├── table: default.test_ngram_index_db.t2
├── scan id: 0
├── output columns: [id (#0), content (#1)]
├── read rows: 10
├── read size: < 1 KiB
├── partitions total: 3
├── partitions scanned: 5
├── pruning stats: [segments: <range pruning: 3 to 3 cost: <slt:ignore>>, blocks: <range pruning: 14 to 6 cost: <slt:ignore>, bloom pruning: 6 to 5 cost: <slt:ignore>>]
├── push downs: [filters: [is_true(like(t2.content (#1), '%your eggs%'))], limit: NONE]
└── estimated rows: 0.11

statement ok
CREATE OR REPLACE TABLE t3 (id int, content1 string, content2 string)

statement ok
INSERT INTO t3 VALUES
(1, 'The quick brown fox jumps over the lazy dog', 'Time flies like an arrow; fruit flies like a banana'),
(2, 'A picture is worth a thousand words', 'Beauty is in the eye of the beholder');

statement ok
INSERT INTO t3 VALUES
(3, 'The early bird catches the worm', 'When life gives you lemons, make lemonade'),
(4, 'Actions speak louder than words', 'Put all your eggs in one basket');

query II
select block_size, bloom_filter_size, ngram_index_size from fuse_block('test_ngram_index_db', 't3');
----
209 894 NULL
240 894 NULL

statement ok
CREATE NGRAM INDEX idx1 ON t3(content1, content2) gram_size = 5 bloom_size = 1048576

statement ok
REFRESH NGRAM INDEX idx1 ON t3

query III
select block_size, bloom_filter_size, ngram_index_size from fuse_block('test_ngram_index_db', 't3');
----
209 2098570 2097234
240 2098570 2097234

query ITT
SELECT * FROM t3 WHERE content1 like '%speak%'
----
4 Actions speak louder than words Put all your eggs in one basket

query T
EXPLAIN SELECT * FROM t3 WHERE content1 like '%speak%'
----
Filter
├── output columns: [t3.id (#0), t3.content1 (#1), t3.content2 (#2)]
├── filters: [is_true(like(t3.content1 (#1), '%speak%'))]
├── estimated rows: 0.25
└── TableScan
    ├── table: default.test_ngram_index_db.t3
    ├── scan id: 0
    ├── output columns: [id (#0), content1 (#1), content2 (#2)]
    ├── read rows: 2
    ├── read size: < 1 KiB
    ├── partitions total: 2
    ├── partitions scanned: 1
    ├── pruning stats: [segments: <range pruning: 2 to 2 cost: <slt:ignore>>, blocks: <range pruning: 2 to 2 cost: <slt:ignore>, bloom pruning: 2 to 1 cost: <slt:ignore>>]
    ├── push downs: [filters: [is_true(like(t3.content1 (#1), '%speak%'))], limit: NONE]
    └── estimated rows: 4.00

query ITT
SELECT * FROM t3 WHERE content2 like '%arrow%'
----
1 The quick brown fox jumps over the lazy dog Time flies like an arrow; fruit flies like a banana

query T
EXPLAIN SELECT * FROM t3 WHERE content2 like '%arrow%'
----
Filter
├── output columns: [t3.id (#0), t3.content1 (#1), t3.content2 (#2)]
├── filters: [is_true(like(t3.content2 (#2), '%arrow%'))]
├── estimated rows: 0.25
└── TableScan
    ├── table: default.test_ngram_index_db.t3
    ├── scan id: 0
    ├── output columns: [id (#0), content1 (#1), content2 (#2)]
    ├── read rows: 2
    ├── read size: < 1 KiB
    ├── partitions total: 2
    ├── partitions scanned: 1
    ├── pruning stats: [segments: <range pruning: 2 to 2 cost: <slt:ignore>>, blocks: <range pruning: 2 to 2 cost: <slt:ignore>, bloom pruning: 2 to 1 cost: <slt:ignore>>]
    ├── push downs: [filters: [is_true(like(t3.content2 (#2), '%arrow%'))], limit: NONE]
    └── estimated rows: 4.00

statement ok
USE default

statement ok
DROP DATABASE IF EXISTS test_ngram_index_db
