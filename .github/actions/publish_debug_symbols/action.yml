name: "Publish Debug Symbols"
description: "Publish debug symbols to GitHub releases and R2"
inputs:
  version:
    description: "Release version"
    required: true
  target:
    description: "Release target"
    required: true
  category:
    description: "Release default/docker"
    required: false
    default: default
  sha:
    description: "Git SHA for artifact download"
    required: true

runs:
  using: "composite"
  steps:
    - name: Download artifact
      uses: ./.github/actions/artifact_download
      with:
        sha: ${{ inputs.sha }}
        target: ${{ inputs.target }}
        category: ${{ inputs.category }}
        artifacts: query.debug
        path: distro/bin

    - name: Prepare artifact
      id: prepare
      shell: bash
      run: |
        publish_name="databend-debug-${{ inputs.category }}-${{ inputs.version }}-${{ inputs.target }}.tar.gz"
        symbol_name="databend-query-${{ inputs.category }}-${{ inputs.version }}-${{ inputs.target }}.debug"
        mv "distro/bin/databend-query.debug" "distro/bin/${symbol_name}"
        tar -C distro/bin -czvf "${publish_name}" "${symbol_name}"
        rm "distro/bin/${symbol_name}"
        echo "name=${publish_name}" >> $GITHUB_OUTPUT

    - name: Update debug symbols to github
      shell: bash
      run: |
        gh release upload ${{ inputs.version }} ${{ steps.prepare.outputs.name }} --clobber
