name: "Check"
description: "Check will do all essential checks"
inputs:
  github_token:
    description: "GitHub Token"
    required: true
runs:
  using: "composite"
  steps:
    - name: Setup Build Tool
      uses: ./.github/actions/setup_build_tool
      with:
        bypass_env_vars: RUSTFLAGS,RUST_LOG,GITHUB_TOKEN

    - name: Check Apache License Header
      uses: korandoru/hawkeye@v2

    - name: Check Elastic License Header
      uses: korandoru/hawkeye@v2
      with:
        config: licenserc-ee.toml

    - name: YAML Lint
      shell: bash
      run: make lint-yaml

    - name: Format
      shell: bash
      run: cargo fmt --all -- --check

    - name: Check typos
      shell: bash
      run: typos

    - name: Check unused deps
      shell: bash
      run: cargo machete

    - name: Check toml format
      shell: bash
      run: taplo fmt --check

    - name: Install newer cargo-audit
      shell: bash
      run: cargo install cargo-audit --locked --force --version 0.21.2

    - name: Prepare advisory-db snapshot (pin before CVSS 4.0)
      shell: bash
      run: |
        set -euxo pipefail
        rm -rf target/advisory-db
        git clone --no-checkout https://github.com/RustSec/advisory-db.git target/advisory-db
        git -C target/advisory-db checkout "$(git -C target/advisory-db rev-list -n 1 --before="2024-01-01" HEAD)"
        rm -rf target/advisory-db/.git

    - name: Audit dependencies
      shell: bash
      if: "!contains(github.event.head_commit.message, 'skip audit')"
      run: cargo audit --db ./target/advisory-db --no-fetch

    - name: Clippy
      shell: bash
      run: cargo -Zgitoxide=fetch -Zgit=shallow-index,shallow-deps clippy --workspace --all-targets --all-features -- -D warnings
