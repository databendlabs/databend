name: "Build Bindings python"
description: "Build with python bindings"
inputs:
  target:
    description: ""
    required: true
  version:
    description: ""
    required: false
runs:
  using: "composite"
  steps:
    - name: Generate version
      working-directory: src/bendpy
      if: inputs.version
      shell: bash
      run: |
        raw_version="${{ inputs.version }}"
        # Remove v prefix: v1.2.3-nightly -> 1.2.3-nightly
        version_no_v=${raw_version/v/}
        # Convert to Python-compatible version: 1.2.3-nightly -> 1.2.3.dev0, 1.2.3-p1 -> 1.2.3.post1
        VERSION=$(echo "$version_no_v" | sed 's/-nightly/.dev0/' | sed 's/-p\([0-9]*\)/.post\1/')
        echo "building version: $raw_version -> $VERSION"
        sed "s#version = \"0.1.0\"#version = \"$VERSION\"#g" Cargo.toml > Cargo.toml.bak
        sed "s#version = \"0.1.0\"#version = \"$VERSION\"#g" pyproject.toml > pyproject.toml.bak

        mv Cargo.toml.bak Cargo.toml
        mv pyproject.toml.bak pyproject.toml

        echo "version in Cargo.toml: $(grep 'version' Cargo.toml)"
        echo "version in pyproject.toml: $(grep 'version' pyproject.toml)"

    - name: Get Toolchain
      id: toolchain
      shell: bash
      run: |
        RUST_TOOLCHAIN=$(awk -F'[ ="]+' '$1 == "channel" { print $2 }' rust-toolchain.toml)
        echo "RUST_TOOLCHAIN=${RUST_TOOLCHAIN}" >> $GITHUB_OUTPUT

    - name: Get opts
      id: opts
      shell: bash
      run: |
        if [[ -z "${{ inputs.version }}" ]]; then
          echo "BUILD_ARGS=--strip --out dist" >> $GITHUB_OUTPUT
        else
          echo "BUILD_ARGS=--release --strip --out dist" >> $GITHUB_OUTPUT
        fi

    - name: Cross setup for macOS
      if: endsWith(inputs.target, '-darwin')
      shell: bash
      run: |
        bash ./scripts/setup/dev_setup.sh -yb
        echo "JEMALLOC_SYS_WITH_LG_PAGE=14" >> $GITHUB_ENV
        echo "JEMALLOC_SYS_WITH_MALLOC_CONF=oversize_threshold:0,dirty_decay_ms:5000,muzzy_decay_ms:5000" >> $GITHUB_ENV

    - name: Setup uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Build wheels
      if: inputs.version
      uses: PyO3/maturin-action@v1
      with:
        rust-toolchain: ${{ steps.toolchain.outputs.RUST_TOOLCHAIN }}
        working-directory: src/bendpy
        target: ${{ inputs.target }}
        manylinux: "2_28"
        # Keep them in one line due to https://github.com/PyO3/maturin-action/issues/153
        rustup-components: rustfmt
        args: ${{ steps.opts.outputs.BUILD_ARGS }}
        docker-options: --env RUSTC_WRAPPER=sccache --env SCCACHE_GCS_RW_MODE=READ_WRITE --env SCCACHE_GCS_BUCKET=databend-ci --env SCCACHE_GCS_KEY_PREFIX=cache/sccache/ --env MATURIN_NO_AUTO_INSTALL=1
        container-options: --platform linux/amd64
        before-script-linux: |
          unset RUSTC_WRAPPER
          # Add the target for the specified architecture
          rustup target add ${{ inputs.target }}
          # Install cargo-zigbuild manually to avoid musl target issues
          cargo install cargo-zigbuild --target ${{ inputs.target }}
          ../../scripts/setup/dev_setup.sh -yb
          # Clean up any existing virtual environment
          rm -rf .venv || true
          uv venv --python=python3.12
          uv sync --all-groups --all-extras

    - name: Setup Rust for development builds
      if: inputs.version == ''
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ steps.toolchain.outputs.RUST_TOOLCHAIN }}
        components: rustfmt

    - name: Build development wheel and run tests
      if: inputs.version == ''
      shell: bash
      working-directory: src/bendpy
      run: |
        echo "Building development wheel for testing..."

        # Clean up any existing virtual environment
        rm -rf .venv || true

        # Create and activate virtual environment
        uv venv --python python3.12
        source .venv/bin/activate

        # Install development dependencies
        uv pip install maturin pytest pandas polars pyarrow

        # Ensure we have a clean environment
        export PATH="$HOME/.local/bin:$PATH"
        export PATH="$HOME/.cargo/bin:$PATH"

        echo "Running development build tests..."
        maturin develop -E test --quiet

        # Run pytest tests
        echo "Executing pytest tests..."
        python -m pytest tests/ -v --tb=short

        echo "All Python binding tests passed!"

    - name: Test built wheels
      if: inputs.version != ''
      shell: bash
      working-directory: src/bendpy
      run: |
        echo "Testing built wheels..."

        # Clean up any existing virtual environment
        rm -rf .venv || true

        # Install from built wheel for release testing
        uv venv --python python3.12
        source .venv/bin/activate
        uv pip install dist/*.whl
        uv pip install pytest pandas polars pyarrow

        # Run pytest tests
        echo "Executing pytest tests..."
        python -m pytest tests/ -v --tb=short

        echo "All Python binding tests passed!"
